---
title: "Getting to know CELESTA"
output: pdf_document
date: "2024-05-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(CELESTA)
library(Rmixmod)
library(spdep)
library(ggplot2)
library(reshape2)
library(zeallot)

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
print(getwd())
writeLines(capture.output(sessionInfo()), "sessionInfo.txt")
```

## Function running celesta 
 Function based on CELESTA README on github (https://github.com/plevritis-lab/CELESTA/blob/main/README.md)


```{r}
run_celesta <- function(marker_info_file, imaging_data_file, proj_title=NULL,
                          filter_cells=FALSE,
                          max_iteration=10,cell_change_threshold=0.01,
                          high_expression_threshold_anchor=rep(0.7, length=13),
                          low_expression_threshold_anchor=rep(0.9, length=13),
                          high_expression_threshold_index=rep(0.5, length=13),
                          low_expression_threshold_index=rep(1, length=13)) {
  prior_marker_info <- read.csv(marker_info_file)
  imaging_data <- read.csv(imaging_data_file)
  colnames(prior_marker_info)[1] <-""
  if(is.null(proj_title)) proj_title <- tail(strsplit(strsplit(imaging_data_file, "[.]")[[1]][1], "[/]")[[1]], n=1)
  CelestaObj <- CreateCelestaObject(project_title = proj_title,prior_marker_info,imaging_data)
  if(filter_cells){CelestaObj <- FilterCells(CelestaObj)}
  CelestaObj <- AssignCells(CelestaObj,
                            max_iteration=max_iteration,
                            cell_change_threshold=cell_change_threshold,
                            high_expression_threshold_anchor=high_expression_threshold_anchor,
                            low_expression_threshold_anchor=low_expression_threshold_anchor,
                            high_expression_threshold_index=high_expression_threshold_index,
                            low_expression_threshold_index=low_expression_threshold_index)  
  return (CelestaObj)
  }
```

```{r}
celesta_output_summary <- function(img_file_path) {
  celesta_out <- paste(tail(strsplit(strsplit(img_file_path, "[.]")[[1]][1], "[/]")[[1]], n=1), "final_cell_type_assignment.csv",sep="_")
  celesta_out <- read.csv(celesta_out)
  head(celesta_out)
  print("Assigned cells stats")
  table(celesta_out$Final.cell.type)
}
```

## CELESTA on data provided on CELESTA github 
1. prior marker info: https://github.com/plevritis-lab/CELESTA/blob/main/data/prior_marker_info.csv
2. imaging data: https://github.com/plevritis-lab/CELESTA/blob/main/data/imaging_data.csv

```{r celesta_data}
img_path <- "data/celesta_org_data/imaging_data.csv"
marker_info_path <- "data/celesta_org_data/prior_marker_info.csv"

run_celesta(marker_info_path, img_path, proj_title = "celesta_on celesta_data")
```

```{r}
celesta_output_summary("celesta_on celesta_data")
```
## CELESTA on a subset of our data (same round in lineage level)

```{r our_data}
proj_1 <- "our_data_1"
img_path_1 <- "data/exprs_data/IMMUcan_Batch20220908_S-220729-00002_002_roi_2.csv"
marker_info_path_1 <- "data/marker_info_data/markers_table_same_round.csv"

run_celesta(marker_info_path_1, img_path_1, proj_title = proj_1)
```

The marker info had lineage level corresponding to considering all cell types in the same round (probably does not make sense):
```{r}
read.csv(marker_info_path_1)
```

Celesta output summary:
```{r}
celesta_output_summary(proj_1)

```

## For marker info with 0.5:
```{r marker_info_with_halfs}
img_path_2 <- "data/exprs_data/IMMUcan_Batch20220908_S-220729-00002_002_roi_2.csv"
marker_info_path_2 <- "data/marker_info_data/markers_table_same_round_halfs.csv"
proj_2 <- "with_halfs"

run_celesta(marker_info_path_2, img_path_2, proj_title = proj_2)
```

```{r}
celesta_output_summary(proj_2)
```

## Trying different thresholds:
```{r thresholds_1}
proj_3 <- "thresholds_1"
run_celesta(marker_info_path_1, img_path_1, proj_title=proj_3, 
            max_iteration=10,cell_change_threshold=0.01,
            high_expression_threshold_anchor=rep(0.5, length=13),
            low_expression_threshold_anchor=rep(1, length=13),
            high_expression_threshold_index=rep(0.4, length=13),
            low_expression_threshold_index=rep(1, length=13))

```

```{r}
celesta_output_summary(proj_3)

```


